# 国債データベース構築プロジェクト - サマリー

**最終更新**: 2025年10月26日（Phase 3完了）  
**プロジェクト開始**: 2025年10月19日

---

## 📈 プロジェクト進捗

### Phase 3完了（2025年10月26日）✅
- 番号付きリストパーサー実装
- 抽出成功率: 13.4% → 63.7%（+375%）
- 総発行額: 11.97兆円 → 299.19兆円（+2,400%）
- BigQuery投入成功（20251026データセット）

### 次：Phase 4（v4汎用パーサー実装）🎯
- 残り65ファイル（36.3%）の処理
- 法令と国債種別の正確なマッチング
- 財務省統計との完全一致（目標193.46兆円）

---

## 📊 現在のデータ状況（データセット: 20251026）

### 投入済みデータ
- **投入件数**: 114件
- **総発行額**: 299.19兆円
- **抽出成功率**: 63.7%（114/179ファイル）
- **スキーマ**: 23フィールド
- **プライマリキー**: issuance_id

### 主要内訳
| 区分 | 発行額（兆円） | 件数 | 備考 |
|------|---------------|------|------|
| **借換債** | 171.43 | 78 | 特別会計法第46条第1項 |
| **年金特例債** | 98.28 | 22 | Phase 4で特例債に再分類予定 |
| **GX経済移行債** | 8.30 | 3 | |
| **前倒債** | 8.93 | 4 | 特別会計法第47条第1項 |
| **その他** | 12.24 | 7 | 法的根拠未分類 |
| **合計** | **299.19** | **114** | |

### 財務省統計との比較
| 区分 | 財務省実績 | BigQuery実績 | 差異 | 状況 |
|------|-----------|-------------|------|------|
| **合計** | 193.46兆円 | 299.19兆円 | +105.73兆円 | Phase 4で調査 |
| 借換債 | 153.92兆円 | 171.43兆円 | +17.51兆円 | 要検証 |
| 特例債 | 25.93兆円 | ? | ? | 年金特例債を含む？ |
| 4条債 | 9.07兆円 | 0兆円 | -9.07兆円 | 未抽出 |
| 財投債 | 3.00兆円 | 0兆円 | -3.00兆円 | 未抽出 |
| GX債 | 1.54兆円 | 8.30兆円 | +6.76兆円 | 要検証 |

**差異の主因**:
1. 年金特例債98.28兆円が実際は特例債に該当する可能性
2. 財投債と4条債が未抽出（別表形式65ファイル未処理）
3. つなぎ公債の扱いの違い

### 次のステップ
1. **Phase 4**: v4汎用パーサー実装
2. 残り65ファイルの処理
3. 法令→国債種別のマッピング確立
4. 財務省統計との完全一致

---

## 🔧 重要なスクリプト

### データ投入・抽出
- `scripts/01_data_ingestion/integrated_announcement_processor_v2.py` ⭐
  - 発行情報と法的根拠の統合処理
  - BigQuery への自動投入
  - テスト/本番モード選択
  - **現行の本番スクリプト**

### パーサー（3種類） ⭐
1. `parsers/numbered_list_parser.py`
   - 番号付きリスト形式（入札発行）
   - Phase 3で新規実装
   
2. `parsers/table_parser.py`
   - 横並び別表形式
   
3. `parsers/vertical_table_parser.py`
   - 縦並び別表形式

### 統合パーサー
- `parsers/issue_extractor.py`（v2） ⭐
  - 3種類のパーサーを統合
  - 処理優先順位: 番号付きリスト → 横並び → 縦並び

### 法的根拠抽出
- `parsers/legal_basis_extractor_v3_clean.py`
  - 複数法律対応
  - デバッグ出力なし

### データ検証
- `scripts/03_data_validation/check_bigquery_schema.py`
  - BigQuery スキーマ確認
  
- `scripts/04_utilities/analyze_failed_files.py`
  - 失敗ファイルのパターン分析

---

## 📁 データセット構成

### 現行データセット: `20251026` ⭐
- **作成日**: 2025年10月26日
- **目的**: Phase 3本番データ
- **テーブル**: `bond_issuances`（23フィールド）
- **行数**: 114行
- **総発行額**: 299.19兆円

### 旧データセット: `20251025`
- **作成日**: 2025年10月25日
- **目的**: Phase 3初期テスト
- **行数**: 831行（重複・エラーあり）
- **状況**: 参照のみ、新規投入なし

### 旧データセット: `20251019`
- **作成日**: 2025年10月19日
- **目的**: Day 1-3のテストデータ
- **状況**: アーカイブ

---

## 🎯 Phase 別の達成状況

### ✅ Phase 1（フォルダ整理）- 完了
- プロジェクトフォルダ構造の確立
- スクリプトの分類整理
- ドキュメント体系の構築

### ✅ Phase 2（スキーマ設計）- 完了
- BigQuery テーブル設計
- bond_issuances テーブル作成
- 23フィールドのスキーマ確定

### ✅ Phase 3（データ抽出・投入）- 完了
- 3種類のパーサー実装
  - NumberedListParser（新規）
  - TableParser（既存）
  - VerticalTableParser（既存）
- 統合スクリプト作成
- 抽出成功率: 63.7%達成
- 総発行額: 299.19兆円達成

### 🎯 Phase 4（完全一致達成）- 次チャット
**目標**: 財務省統計193.46兆円との完全一致

**実施内容**:
1. **v4汎用パーサーの設計・実装**
   - すべての形式に対応
   - 構文解析ベース
   - 法令の正確な抽出

2. **発行根拠法令ごとの集計**
   - 法律と条項を正確に抽出
   - 法令ごとの発行額算出

3. **財務省資料との照合（答え合わせ方式）**
   - 法令→国債種別のマッピング確立
   - 分類精度の向上
   - 差異の解消

4. **残り65ファイルの処理**
   - 別表形式の特殊パターン
   - 財投債（3.00兆円）
   - 4条債（9.07兆円）

5. **最終検証**
   - 総発行額の確認
   - 種別ごとの発行額確認
   - 完全一致の達成

---

## 🏗️ 技術スタック

### データソース
- **官報告示データ**: 2023年度（令和5年度）
- **ファイル数**: 179ファイル
- **場所**: `G:\マイドライブ\JGBデータ\2023\`
- **形式**: テキストファイル（.txt）

### データベース
- **プラットフォーム**: Google BigQuery
- **プロジェクトID**: `jgb2023`
- **現行データセット**: `20251026`
- **認証**: サービスアカウント

### 開発環境
- **言語**: Python 3.x
- **主要ライブラリ**:
  - google-cloud-bigquery（BigQuery接続）
  - google-auth（認証）
  - pathlib（ファイル操作）
  - re（正規表現）
  - json（データ処理）

### プロジェクト管理
- **ドキュメント**: Markdown
- **バージョン管理**: Git（推奨）
- **引き継ぎ**: progress_log.md, project_summary.md

---

## 📝 ドキュメント構成

### 主要ドキュメント
1. **README.md** - プロジェクト概要
2. **project_summary.md** - このファイル（詳細サマリー）
3. **progress_log.md** - Day 1～5の作業履歴
4. **folder_structure.md** - フォルダ構造の詳細説明
5. **handoff_template.md** - 新チャット開始テンプレート

### 技術ドキュメント
- `docs/design/` - 設計ドキュメント
- `docs/api/` - API仕様（将来用）
- `docs/operation/` - 運用ドキュメント

---

## 🔄 新チャット開始時の手順

Phase 4を新しいチャットで開始する際は、以下を添付してください：

### 必須添付ファイル
1. **project_summary.md**（このファイル）
2. **progress_log.md**（Phase 3完了版）
3. **folder_structure.md**

### 開始メッセージ
```
こんにちは！
前チャットのトークン制限に達したため、国債データベース構築プロジェクトを新しいチャットで継続します。

## 📋 プロジェクト情報
### プロジェクト名
国債データベース構築プロジェクト

### 前チャットURL
[前回のチャットURL]

### 現在の日付
[今日の日付]

### 現在の状況
**Phase 3完了、Phase 4開始**

## 🗂️ 重要なファイルの場所
### BigQuery
- **プロジェクトID**: `jgb2023`
- **現行データセットID**: `20251026`
- **テーブル**: `bond_issuances`（114行、299.19兆円）

## 📎 添付ファイル
1. project_summary.md（Phase 3完了版）
2. progress_log.md（Phase 3完了版）
3. folder_structure.md

## 🎯 Phase 4 の目標
1. v4汎用パーサーの実装
2. 残り65ファイル（36.3%）の処理
3. 法令→国債種別のマッピング確立
4. 財務省統計193.46兆円との完全一致

Phase 4を開始します！
```

---

## 📊 Phase 3 の成果（詳細）

### 抽出成功率の推移
| タイミング | 成功率 | 成功件数 | 総発行額 |
|-----------|--------|---------|---------|
| Phase 3開始時 | 13.4% | 24/179 | 11.97兆円 |
| NumberedListParser実装後 | 63.7% | 114/179 | 299.19兆円 |
| **改善** | **+375%** | **+90件** | **+2,400%** |

### 実装したパーサー
| パーサー | 対応形式 | 抽出件数 | 実装時期 |
|---------|---------|---------|---------|
| TableParser | 横並び別表 | 不明 | Day 1-3 |
| VerticalTableParser | 縦並び別表 | 不明 | Day 4 |
| **NumberedListParser** | **番号付きリスト** | **多数** | **Phase 3** ⭐ |

### データセット推移
| データセット | 作成日 | 行数 | 総発行額 | 状況 |
|------------|--------|------|---------|------|
| 20251019 | Day 1 | - | - | アーカイブ |
| 20251025 | Phase 3初期 | 831 | - | テスト用 |
| **20251026** | **Phase 3完了** | **114** | **299.19兆円** | **本番** ⭐ |

---

## 🎯 Phase 4 への戦略

### 課題の整理
1. **未処理ファイル65件（36.3%）**
   - 別表形式の特殊パターン
   - 財投債と4条債の欠落

2. **法令と国債種別のマッチング**
   - 年金特例債98.28兆円 → 特例債？
   - 法令名からの自動分類

3. **財務省統計との差異**
   - 299.19兆円 vs 193.46兆円（+105.73兆円）
   - 種別ごとの差異解消

### 解決アプローチ（答え合わせ方式）

#### ステップ1: v4汎用パーサー実装
- すべての形式に対応
- 法令の完全・正確な抽出
- 発行額の正確な算出

#### ステップ2: 発行根拠法令ごとの集計
```
特別会計に関する法律第46条第1項: 171.43兆円
財政運営...特例...法律第3条第1項: 98.28兆円
特別会計に関する法律第47条第1項: 8.93兆円
...
```

#### ステップ3: 財務省資料との照合
```
借換債（財務省）: 153.92兆円
→ 特別会計に関する法律第46条第1項: 171.43兆円
→ 差異: +17.51兆円（要調査）

特例債（財務省）: 25.93兆円
→ 財政運営...特例...法律第3条第1項: 98.28兆円
→ 差異: +72.35兆円（つなぎ公債の扱い？）
```

#### ステップ4: マッピングルール確立
```python
LAW_TO_CATEGORY = {
    "特別会計に関する法律第46条第1項": "借換債",
    "財政運営に必要な財源の確保を図るための公債の発行の特例に関する法律第3条第1項": "特例債",
    "特別会計に関する法律第47条第1項": "前倒債",
    "財政法第4条第1項": "4条債",
    ...
}
```

#### ステップ5: 完全一致の達成
- 自動分類の精度向上
- すべての差異を解消
- 193.46兆円との一致

---

## 📞 重要な連絡先・リソース

### 財務省資料
- 国債統計年報: https://www.mof.go.jp/jgbs/publication/annual_report/
- 国債発行計画: https://www.mof.go.jp/jgbs/issuance_plan/
- 国債等関係諸資料: https://www.mof.go.jp/jgbs/reference/appendix/

### プロジェクト情報
- プロジェクトディレクトリ: `C:\Users\sonke\projects\jgb_database_project\`
- 官報データ: `G:\マイドライブ\JGBデータ\2023\`
- 認証ファイル: `C:\Users\sonke\secrets\jgb2023-f8c9b849ae2d.json`

---

**最終更新**: 2025年10月26日  
**Phase 3 完了**: ✅  
**次回**: Phase 4（v4汎用パーサー実装）